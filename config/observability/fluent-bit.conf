[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf

# Collect Docker container logs from all containers
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# Extract container name from file path and add as field
[FILTER]
    Name          modify
    Match         docker.*
    Add           source docker

# Parse JSON log content if present
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  On

# Detect log level from message content
[FILTER]
    Name          lua
    Match         docker.*
    script        /fluent-bit/etc/detect_level.lua
    call          detect_level

# Keep only ERROR and WARNING logs (filter out INFO, DEBUG)
[FILTER]
    Name          grep
    Match         docker.*
    Regex         severity_text (ERROR|WARN|WARNING|FATAL|error|warn|warning|fatal)

# Add service name from container labels or derive from tag
[FILTER]
    Name          modify
    Match         docker.*
    Rename        container_name service.name
    Add           deployment.environment development

# Forward to OTEL Collector
[OUTPUT]
    Name          forward
    Match         docker.*
    Host          otel-collector
    Port          24224
    Tag           logs
